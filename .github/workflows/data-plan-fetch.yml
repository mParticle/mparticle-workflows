name: Fetch Data Plan

on:
    workflow_call:
    
jobs:
    name: "Fetch Data Plan"
    runs-on: ubuntu-latest
    needs: confirm-public-repo-main-branch
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '16.x'

      - name: Install mP CLI
        run: npm install -g @mparticle/cli

      - name: Fetch Data Plans with mp CLI
        id: fetch-data-plans
        env:
          WORKSPACE_ID: ${{ secrets.HIGGS_SHOP_WORKSPACE_ID }}
          CLIENT_ID: ${{ secrets.HIGGS_SHOP_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.HIGGS_SHOP_CLIENT_SECRET }}
        run: |
          mp planning:data-plan-versions:fetch --dataPlanId=higgs_shop_basic_data_plan --versionNumber=1 --outFile=dataplans/higgs_shop_basic_data_plan_1.json --workspaceId=$WORKSPACE_ID --clientId=$CLIENT_ID --clientSecret=$CLIENT_SECRET

      - name: Archive Data Plan Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: higgs-shop-dataplan
          path: core-sdk-samples/higgs-shop-sample-app/dataplans/
